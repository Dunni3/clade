services:
  personal:
    build:
      context: ..
      dockerfile: docker/Dockerfile.test
    stdin_open: true
    tty: true
    depends_on:
      worker:
        condition: service_started
      hearth:
        condition: service_started
    env_file:
      - path: .env
        required: false
    environment:
      HEARTH_URL: http://hearth:8000
      HEARTH_API_KEY: testkey-personal
      HEARTH_NAME: testpersonal
      EMBER_URL: http://worker:8100
      EMBER_API_KEY: testkey-ember
      ANTHROPIC_API_KEY: ${ANTHROPIC_API_KEY:-}

  worker:
    build:
      context: ..
      dockerfile: docker/Dockerfile.test.worker
    depends_on:
      hearth:
        condition: service_started
    env_file:
      - path: .env
        required: false
    environment:
      EMBER_PORT: "8100"
      EMBER_HOST: "0.0.0.0"
      EMBER_BROTHER_NAME: testember
      EMBER_WORKING_DIR: /home/testuser
      HEARTH_API_KEY: testkey-ember
      HEARTH_URL: http://hearth:8000
      HEARTH_NAME: testember
      ANTHROPIC_API_KEY: ${ANTHROPIC_API_KEY:-}

  hearth:
    build:
      context: ..
      dockerfile: docker/Dockerfile.test.hearth
    ports:
      - "8000:8000"
    env_file:
      - path: .env
        required: false
    environment:
      # Hearth server config
      MAILBOX_API_KEYS: "testkey-personal:testpersonal,testkey-ember:testember,testkey-kamaji:kamaji"
      MAILBOX_DB_PATH: "/data/hearth.db"
      # Conductor config (used by clade-conductor MCP during ticks via docker compose exec)
      HEARTH_URL: http://localhost:8000
      HEARTH_API_KEY: testkey-kamaji
      HEARTH_NAME: kamaji
      CONDUCTOR_WORKERS_CONFIG: /opt/clade/docker/test-conductor-workers.yaml
      CONDUCTOR_TICK_CMD: "runuser -u testuser -- bash /home/testuser/.config/clade/conductor-tick.sh"
      ANTHROPIC_API_KEY: ${ANTHROPIC_API_KEY:-}
    volumes:
      - hearth-data:/data

  frontend:
    build:
      context: ..
      dockerfile: docker/Dockerfile.test.frontend
    ports:
      - "5173:5173"
    depends_on:
      hearth:
        condition: service_started
    environment:
      API_PROXY_TARGET: http://hearth:8000

volumes:
  hearth-data:
