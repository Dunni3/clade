FROM python:3.12-slim

RUN apt-get update && apt-get install -y curl tmux git && rm -rf /var/lib/apt/lists/*

# Install Claude Code (native installer, no Node.js required)
RUN curl -fsSL https://claude.ai/install.sh | bash \
    && cp /root/.local/bin/claude /usr/local/bin/claude

ENV TERM=xterm

# Create test user (for conductor ticks via docker compose exec -u testuser)
RUN useradd -m -s /bin/bash testuser \
    && mkdir -p /home/testuser/.claude /home/testuser/.config/clade \
    && chown -R testuser:testuser /home/testuser/.claude /home/testuser/.config/clade

# Copy project and install hearth deps + clade package (for clade-conductor)
COPY . /opt/clade
RUN pip install --no-cache-dir -r /opt/clade/hearth/requirements.txt \
    && pip install --no-cache-dir -e "/opt/clade"

# Pre-bake conductor config for event-driven ticks
RUN echo '{"mcpServers":{"clade-conductor":{"command":"clade-conductor"}}}' \
    > /home/testuser/.config/clade/conductor-mcp.json
COPY deploy/conductor-tick.sh /home/testuser/.config/clade/conductor-tick.sh
COPY deploy/conductor-tick.md /home/testuser/.config/clade/conductor-tick.md
RUN chmod +x /home/testuser/.config/clade/conductor-tick.sh \
    && chown -R testuser:testuser /home/testuser/.config/clade/

# Data directory for SQLite
RUN mkdir -p /data
ENV MAILBOX_DB_PATH=/data/hearth.db

ENV PATH="/home/testuser/.local/bin:$PATH"

EXPOSE 8000
WORKDIR /opt/clade
CMD ["uvicorn", "hearth.app:app", "--host", "0.0.0.0", "--port", "8000"]
