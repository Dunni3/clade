# Docker Compose Test Environment

A multi-container environment for testing the full `clade` CLI onboarding flow — `clade init`, `clade add-brother`, `clade status`, and `clade doctor` — plus Ember task delegation and Conductor orchestration, without needing real SSH hosts or a deployed Hearth server.

## Architecture

Five containers on a shared Docker network:

| Container | Role | What it runs |
|-----------|------|-------------|
| `personal` | Personal brother (coordinator) | clade CLI, Claude Code, SSH client |
| `worker` | Worker brother (SSH target) | sshd, Claude Code, python3, git, tmux |
| `hearth` | Communication hub | FastAPI + uvicorn (hearth server), Claude Code |
| `ember` | Ember server (HTTP task executor) | clade-ember (FastAPI on port 8100), tmux |
| `conductor` | Conductor (Kamaji) | clade CLI, Claude Code (interactive shell) |

Docker Compose DNS lets all containers reach each other by service name.

```
┌─────────────┐     SSH      ┌─────────────┐
│  personal   │─────────────▶│   worker     │
│  (clade CLI)│              │   (sshd)     │
└──────┬──────┘              └─────────────┘
       │
       │ HTTP                ┌─────────────┐
       ├────────────────────▶│   ember      │
       │                     │  (clade-ember│
       │                     │   port 8100) │
       │                     └──────▲───────┘
       │ HTTP                       │ HTTP
       ▼                            │
┌─────────────┐              ┌──────┴──────┐
│   hearth    │◀─────────────│  conductor  │
│  (FastAPI)  │    HTTP      │  (kamaji)   │
└─────────────┘              └─────────────┘
```

## Quick Start

```bash
bash scripts/test-compose.sh
```

This will:
1. Generate throwaway SSH keys in `test-keys/` (if not already present)
2. Build all five container images
3. Start the containers in the background
4. Drop you into a bash shell on the `personal` container

Claude Code is pre-installed but **not authenticated**. Run `claude login` inside each container to log in with your account. This must be done manually after each rebuild — login state does not persist across container rebuilds.

```bash
# Authenticate Claude Code (interactive — opens a browser URL to complete)
claude login
```

From there, run the onboarding flow:

```bash
clade init --name "Test Clade" --personal-name darwin --server-url http://hearth:8000 --server-key testkey-personal -y
clade add-brother --ssh testuser@worker --name curie -y
clade status
clade doctor
```

The `--server-key testkey-personal` flag bootstraps the first key registration: darwin's generated key gets registered with the Hearth using the pre-configured test key. After that, `add-brother` uses darwin's key to register curie's key automatically.

## Files

All Docker files live in `docker/`:

| File | Purpose |
|------|---------|
| `docker/Dockerfile.test` | Personal/conductor image — clade CLI, SSH client with pre-loaded key |
| `docker/Dockerfile.test.worker` | Worker/ember image — sshd with authorized key, git, tmux |
| `docker/Dockerfile.test.hearth` | Hearth server image — FastAPI + uvicorn + aiosqlite |
| `docker/docker-compose.test.yml` | Wires the five services together |
| `docker/test-conductor-workers.yaml` | Static worker registry for the conductor |
| `scripts/test-compose.sh` | Convenience launcher (keygen + build + start + attach) |
| `test-keys/` | Generated SSH keypair (gitignored) |

## SSH Key Exchange

The personal and worker containers share a throwaway ed25519 keypair:

- `test-keys/id_ed25519` → copied into `personal` at `/home/testuser/.ssh/id_ed25519`
- `test-keys/id_ed25519.pub` → copied into `worker` at `/home/testuser/.ssh/authorized_keys`

Keys are generated by `scripts/test-compose.sh` on first run. The `test-keys/` directory is gitignored — delete it to regenerate.

The personal container also has `StrictHostKeyChecking no` configured for the `worker` host so SSH connects without prompting.

## API Keys

The hearth container comes pre-configured with four test API keys:

| Key | Name | Used by |
|-----|------|---------|
| `testkey-personal` | `testpersonal` | Personal container (set via env vars) |
| `testkey-worker` | `testworker` | Worker container |
| `testkey-ember` | `testember` | Ember container (auth for incoming requests + Hearth access) |
| `testkey-kamaji` | `kamaji` | Conductor container |

Additional keys generated by `clade init --server-key` and `clade add-brother` are dynamically registered with the Hearth via its `/api/v1/keys` endpoint.

## Ember Server

The `ember` service runs the Ember HTTP server (`clade-ember`) using the worker image with an overridden command. It:

- Listens on port 8100 inside the Docker network
- Authenticates requests with `testkey-ember`
- Launches Claude Code tasks in local tmux sessions
- Reports to the Hearth at `http://hearth:8000`

Test it from inside any container:

```bash
# Health check (unauthenticated)
curl http://ember:8100/health

# Execute a task (authenticated)
curl -X POST http://ember:8100/tasks/execute \
  -H "Authorization: Bearer testkey-ember" \
  -H "Content-Type: application/json" \
  -d '{"prompt": "echo hello", "subject": "test"}'

# Check active tasks (authenticated)
curl http://ember:8100/tasks/active \
  -H "Authorization: Bearer testkey-ember"
```

## Conductor (Kamaji)

The `conductor` service provides an interactive shell for testing Conductor functionality. It has no long-running process — you `exec` into it to run conductor ticks manually or test the `clade-conductor` MCP server.

```bash
# From the host machine:
docker compose -f docker/docker-compose.test.yml exec conductor bash

# Inside the conductor container:
# Check Ember health
curl http://ember:8100/health

# The conductor's worker registry is at:
cat /home/testuser/clade/docker/test-conductor-workers.yaml
```

The conductor container has `CONDUCTOR_WORKERS_CONFIG` pointing to the test worker registry, which maps `testember` to `http://ember:8100`.

## What Gets Tested

### `clade init`
- Config file creation (`~/.config/clade/clade.yaml`)
- API key generation (`~/.config/clade/keys.json`)

### `clade add-brother`

| Step | Expected Result |
|------|----------------|
| SSH test | `ssh testuser@worker echo ok` succeeds via Docker network |
| Prereq check | python3 OK, git OK, tmux OK, claude OK |
| Deploy | Skipped with `--no-deploy` (or: clade is pre-installed on worker) |
| API key gen | Creates key in `~/.config/clade/keys.json` |
| Config update | Adds brother to `~/.config/clade/clade.yaml` |

### `clade status` / `clade doctor`
Runs diagnostics across all brothers and the server. Some expected failures in the test environment:
- **Server shows DOWN**: The Hearth has no `/api/v1/health` endpoint; status falls back to checking `/` which also 404s. The API itself works fine.
- **MCP not registered**: Expected when using `--no-mcp`.
- **Identity not found**: Expected when using `--no-identity`.

### Ember delegation
From the personal container (or any container with the right env vars):
1. Create a task in the Hearth
2. Send it to the Ember via HTTP
3. Ember launches a tmux session with Claude Code
4. Task status updates flow through the Hearth

### End-to-end thrum flow
1. Create a thrum via the Hearth API from the personal container
2. Exec into the conductor and run the conductor MCP tools (or manually call the delegation API)
3. Verify the task appears on the Ember and updates propagate to the Hearth

## Common Operations

```bash
# Rebuild after code changes
docker compose -f docker/docker-compose.test.yml up --build -d

# Attach to the personal container
docker compose -f docker/docker-compose.test.yml exec personal bash

# Attach to the conductor
docker compose -f docker/docker-compose.test.yml exec conductor bash

# View hearth logs
docker compose -f docker/docker-compose.test.yml logs hearth

# View ember logs
docker compose -f docker/docker-compose.test.yml logs ember

# SSH from personal to worker manually
docker compose -f docker/docker-compose.test.yml exec personal ssh testuser@worker

# Stop everything
docker compose -f docker/docker-compose.test.yml down

# Stop and remove volumes (reset hearth DB)
docker compose -f docker/docker-compose.test.yml down -v

# Regenerate SSH keys
rm -rf test-keys && bash scripts/test-compose.sh
```

## Claude Code Authentication

Claude Code is installed on all containers at build time, but authentication must be done manually after each rebuild. Run `claude login` inside each container — it will print a URL to open in your browser to complete OAuth.

```bash
# Personal — you're already here after test-compose.sh drops you in
claude login

# Worker — SSH from inside the personal container
ssh testuser@worker
claude login

# Hearth — use docker compose exec from the host machine
docker compose -f docker/docker-compose.test.yml exec hearth bash
claude login

# Conductor — use docker compose exec from the host machine
docker compose -f docker/docker-compose.test.yml exec conductor bash
claude login
```

Login state lives in `~/.claude/` inside the container and is lost when the container is rebuilt. To persist it across rebuilds, you could volume-mount the auth directory, but this is generally not needed for quick test sessions.

## Limitations

- **Claude Code login is ephemeral**: `claude login` must be re-run after each container rebuild.
- **Hearth API key bootstrap**: The pre-configured test keys in `docker/docker-compose.test.yml` are used to bootstrap. Keys generated by `clade init --server-key` and `clade add-brother` are dynamically registered with the Hearth via its `/api/v1/keys` endpoint.
- **Ember task execution requires Claude login**: The Ember launches Claude Code sessions, so `claude login` must be run on the ember container before tasks will actually execute. The Ember itself starts fine without auth.
