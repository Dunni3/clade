# Docker Compose Test Environment

A multi-container environment for testing the full `clade` CLI onboarding flow — `clade init`, `clade add-brother`, `clade status`, and `clade doctor` — without needing real SSH hosts or a deployed Hearth server.

## Architecture

Three containers on a shared Docker network:

| Container | Role | What it runs |
|-----------|------|-------------|
| `personal` | Personal brother (coordinator) | clade CLI, SSH client |
| `worker` | Worker brother (SSH target) | sshd, python3, git, tmux |
| `hearth` | Communication hub | FastAPI + uvicorn (hearth server) |

Docker Compose DNS lets `personal` reach `worker` and `hearth` by service name.

```
┌─────────────┐     SSH      ┌─────────────┐
│  personal   │─────────────▶│   worker     │
│  (clade CLI)│              │   (sshd)     │
└──────┬──────┘              └─────────────┘
       │
       │ HTTP
       ▼
┌─────────────┐
│   hearth    │
│  (FastAPI)  │
└─────────────┘
```

## Quick Start

```bash
bash scripts/test-compose.sh
```

This will:
1. Generate throwaway SSH keys in `test-keys/` (if not already present)
2. Build all three container images
3. Start the containers in the background
4. Drop you into a bash shell on the `personal` container

From there, run the onboarding flow:

```bash
# Initialize the clade
clade init \
  --name "Test Clade" \
  --personal-name darwin \
  --server-url http://hearth:8000 \
  --no-mcp \
  --no-identity \
  -y

# Add the worker brother
clade add-brother \
  --ssh testuser@worker \
  --name curie \
  --no-deploy \
  --no-identity \
  --no-mcp \
  -y

# Check health
clade status
clade doctor
```

## Files

All Docker files live in `docker/`:

| File | Purpose |
|------|---------|
| `docker/Dockerfile.test` | Personal brother image — clade CLI, SSH client with pre-loaded key |
| `docker/Dockerfile.test.worker` | Worker brother image — sshd with authorized key, git, tmux |
| `docker/Dockerfile.test.hearth` | Hearth server image — FastAPI + uvicorn + aiosqlite |
| `docker/docker-compose.test.yml` | Wires the three services together |
| `scripts/test-compose.sh` | Convenience launcher (keygen + build + start + attach) |
| `test-keys/` | Generated SSH keypair (gitignored) |

## SSH Key Exchange

The personal and worker containers share a throwaway ed25519 keypair:

- `test-keys/id_ed25519` → copied into `personal` at `/home/testuser/.ssh/id_ed25519`
- `test-keys/id_ed25519.pub` → copied into `worker` at `/home/testuser/.ssh/authorized_keys`

Keys are generated by `scripts/test-compose.sh` on first run. The `test-keys/` directory is gitignored — delete it to regenerate.

The personal container also has `StrictHostKeyChecking no` configured for the `worker` host so SSH connects without prompting.

## Hearth Server

The hearth container runs the real Hearth FastAPI server from `hearth/`. It comes pre-configured with two test API keys:

| Key | Name | For |
|-----|------|-----|
| `testkey-personal` | `testpersonal` | Personal container (set via env vars) |
| `testkey-worker` | `testworker` | Worker container |

The personal container has `HEARTH_URL`, `HEARTH_API_KEY`, and `HEARTH_NAME` set in its environment, so the MCP server would connect automatically if running.

To test the Hearth API directly:

```bash
# From inside the personal container:
curl http://hearth:8000/api/v1/messages -H "Authorization: Bearer testkey-personal"
```

## What Gets Tested

### `clade init`
- Config file creation (`~/.config/clade/clade.yaml`)
- API key generation (`~/.config/clade/keys.json`)

### `clade add-brother`

| Step | Expected Result |
|------|----------------|
| SSH test | `ssh testuser@worker echo ok` succeeds via Docker network |
| Prereq check | python3 OK, git OK, tmux OK, claude NOT FOUND (expected) |
| Deploy | Skipped with `--no-deploy` (or: clade is pre-installed on worker) |
| API key gen | Creates key in `~/.config/clade/keys.json` |
| Config update | Adds brother to `~/.config/clade/clade.yaml` |

### `clade status` / `clade doctor`
Runs diagnostics across all brothers and the server. Some expected failures in the test environment:
- **Server shows DOWN**: The Hearth has no `/api/v1/health` endpoint; status falls back to checking `/` which also 404s. The API itself works fine.
- **MCP not registered**: Expected when using `--no-mcp`.
- **Identity not found**: Expected when using `--no-identity`.

## Common Operations

```bash
# Rebuild after code changes
docker compose -f docker/docker-compose.test.yml up --build -d

# Attach to the personal container
docker compose -f docker/docker-compose.test.yml exec personal bash

# View hearth logs
docker compose -f docker/docker-compose.test.yml logs hearth

# SSH from personal to worker manually
docker compose -f docker/docker-compose.test.yml exec personal ssh testuser@worker

# Stop everything
docker compose -f docker/docker-compose.test.yml down

# Stop and remove volumes (reset hearth DB)
docker compose -f docker/docker-compose.test.yml down -v

# Regenerate SSH keys
rm -rf test-keys && bash scripts/test-compose.sh
```

## Limitations

- **No Claude Code on worker**: The worker container doesn't have Claude Code installed, so `add-brother` reports it as NOT FOUND. This is expected — Claude Code is installed manually in real deployments.
- **No MCP registration testing**: `--no-mcp` skips writing `~/.claude.json`. Testing MCP registration would require a Claude Code installation on the worker.
- **No identity testing**: `--no-identity` skips writing `~/.claude/CLAUDE.md`. Remove the flag to test identity writing.
- **Hearth API keys are static**: The test keys are hardcoded in `docker/docker-compose.test.yml`. Keys generated by `clade init`/`add-brother` won't be recognized by the hearth — they're separate from the pre-configured test keys.
